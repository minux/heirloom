New features in the Heirloom Documentation Tools troff language
===============================================================

The "-xN" option and the ".xflag" request control the availability of
extensions. Four levels are currently defined:

0	disables all extensions except for locale-dependent input and
	AFM/OpenType font selection using ".fp".

1	enables extensions except for direct access to long names on
	request lines, i.e., ".abcde" will be interpreted as request
	".ab" with argument "cde". Long names can be accessed using
	the ".do" request, e.g. ".do papersize a4". Long names in
	escape sequences are recognized, though, e.g. "\*[xyz]"
	refers to the string named "xyz" and not to the string named
	"[". It is normally the only relevant difference, so input
	written for traditional troff can almost always be used
	without change in this mode. This level is the default.

2	also enables direct access to long names on request lines.
	If an undefined long name is read, its first two characters
	are interpreted as a short request using the remaining
	characters as argument. So if a macro "abcde" is defined,
	".abcde" will execute it, but otherwise, ".abcde" continues
	to execute ".ab". String and number register references are
	only interpreted if they start in the first two characters
	of a name, i.e. no string interpretation is performed on
	input ".ab\*(xy".

3	ignores undefined long requests even if they form a prefix
	of a short request, and interprets string and number register
	references in any position of a name.

It is recommended to execute ".do xflag 3" in the first line of new
troff programs that need not rely on any existing code.


Locale-dependent input characters
=================================

nroff allows any printable character of the current locale to appear
in its text input. Such characters are simply passed through.

troff internally converts non-ASCII characters of the current locale
to named PostScript characters once they are read in regular (not copy)
mode. A character that is not present in the current font is searched
using the ".fallback" sequence first, then in the special fonts. If
the character cannot be found, it is discarded. Characters for which
no PostScript name is known are also discarded.

Only ASCII characters are allowed in request, string, font, and number
register names.


New and extended requests
=========================

.bleedat left-offset top-offset width height
	sets the "BleedBox" page parameter for PDF generation. The four
	arguments give the offset from the left and top margins of the
	document (as set by ".mediasize"), and width and height of the
	box. The default units are points. The BleedBox should be defined
	as a a frame around the objects of the actual document including
	any bleed areas (i.e. content that should extend to the end of the
	trimmed final page but is extended a bit such to work around
	possible cutting inaccuracies). Cut marks, color bars, and other
	information for the printing office should be positioned outside
	the BleedBox. See also the ".cropat" and ".trimat" requests.

.chop name
	removes the last character of the macro, string, or diversion
	"name".

.close stream
	closes the file "stream", which must have been obtained by a
	previous ".open" request.

.cropat left-offset top-offset width height
	sets the "CropBox" page parameter for PDF generation. The four
	arguments give the offset from the left and top margins of the
	document (as set by ".mediasize"), and width and height of the
	box. The default units are points. The CropBox restricts the
	area of the page that is shown by a PDF viewer program. It is
	useful to hide cut marks and other printing instructions when
	the same PDF document is intended to be displayed on screen.

.de longname
.ds longname
.ft longname
.nr longname
	The names of macros, strings, number registers, and fonts can be
	longer than two characters now (see also ".xflag").

.do request arguments
	has the same effect as executing ".request arguments" with the
	"-x3" option enabled, even if that was not given on the command
	line.  Thus ".do papersize a4" works like ".papersize a4",
	".do de longname" defines a macro with a long name, and
	".do longname" executes it. It is possible to contract extended
	request names without the "-x3" option, such as ".dopapersize",
	although it is discouraged.

.ev name
	Environments can be named, or be given an arbitrary number.

.evc name
	copies the environment "name" into the current environment.
	The temporary state of the current environment is reset, and
	incompletely filled lines are discarded.

.fallback ff aa bb ...					troff only
	selects the fallback sequence for font ff. If the current font
	is ff and a character is not found, font aa is searched first,
	then font bb, etc. If the character still has not been found,
	it is searched for in font S, then in font 0, 1, and so forth.

.feature ff [+|-]name ...				troff only
	enables (+) or disables (-) the OpenType feature "name" in font
	ff. Only OpenType features that result in context-insensitive
	single-character substitutions are supported. Typical features
	are "onum" to enable old-style numerals, or "smcp" to enable
	small capitals.

.flig ff ligatures					troff only
	defines the set of ligatures to be used with font ff. The
	"ligatures" parameter is the sum of the values 1 for ff, 2 for
	fi, 4 for fl, 8 for ffi, and 16 for ffl. Thus ".flig R 31"
	enables all these ligatures in font R. The default is specific
	to a font and is determined from its AFM/OpenType file. Enabling
	the ff, ffi, and ffl ligatures with PostScript Type 1 fonts
	usually requires an expert font that has been selected for
	character substitution using the ".fallback" request.

.fp r yy metricsname [supplyname]			troff only
	reads metrics from "metricsname", which must be in AFM, OpenType,
	or TrueType format. If the TROFFONTS environment variable is set,
	each of the colon-separated directories in it is tried for the files
	"metricsname.afm", "metricsname.otf", "metricsname.ttf", or, if
	"metricsname" has an ".afm", ".otf", or ".ttf" extension itself,
	for "metricsname". Otherwise, the font is loaded from the file
	"/usr/ucblib/doctools/font/devps/metricsname.afm". If this fails,
	a legacy ditroff font is assumed.
	  The font is then available with ".ft yy", "\f(yy", etc. "yy" may
	be freely chosen. The "r" argument specifies a register on which
	the font is to be mounted. If it is zero, the font is mounted on
	a free position (not on position zero). The "r" argument may
	consist of more than a single digit.
	  "yy" may be the name of an existing ditroff-style font, such
	as "R". In this case, the same register must be reused. For best
	compatibility with conventional troff usage, it is recommended
	that the base fonts of a document are mounted as "1 R", "2 I".
	The initial fonts on positions 9 (S1) and 10 (S) should not be
	changed, as these contain special metrics for drawing commands.
	  "yy" may also consist of more than two characters.
	  If the optional "supplyname" argument is present, glyph data
	is included in the generated PostScript file. If "supplyname"
	is one of "otf", "pfb", "pfa", "ttf", or "t42", the file
	"supplyname.pfb" (or likewise) is searched in the directories
	in TROFFONTS first as described for the AFM file above, and if
	it is not found there, in
	"/usr/ucblib/doctools/font/devps/supplyname.pfb" (or
	likewise). "supplyname" may also be the basename of a file like
	"metricsname" above.

.ftr ff abcd...						troff only
	is a font-specific variant of the ".tr" request. If the current
	character originates from font "ff", character "a" is translated
	to character "b" on output, character "c" by character "d", etc.

.fzoom ff z						troff only
	zooms font ff by "z", where "z" is a positive floating-point
	number. This request is useful for adjusting fonts with different
	visual sizes but identical nominal points; the zoom is thus not
	applied to characters from another font that have been found by
	the fallback sequence.

.hidechar ff c d ...					troff only
	hides the characters c, d, etc. from font ff. If the characters
	appear in input afterwards, they are searched in other fonts
	using the fallback sequence. This is useful e.g. for combining
	characters from a regular and an expert font.

.hylang language
	Sets the hyphenation language to "language", where language
	is one of de_DE, de_DE@traditional, en_US, fr_FR, it_IT, or
	la_VA. Other languages can be made available by adding hyphenation
	files to the directory /usr/ucblib/doctools/hyphen; see the notes
	in "troff/libhnj/hyphen.d" for details. If no "language" argument
	is present, the hyphenation is reset to the traditional troff
	mechanism. Note that hyphenation is disabled by default if troff
	is used directly, and can be switched on using the ".hy" request,
	which is what many macro packages do.

.kern [0|1]						troff only
	Disables (0) or enables pairwise kerning. The default is enabled
	unless the "-x0" option is given.

.kernafter ff char0 units0 char1 units1 ...		troff only
.kernbefore ff char0 units0 char1 units1 ...		troff only
	adds a constant amount of space if the current font is "ff" and
	"char0" is the first (or second, respectively) character of a
	pair of characters subject to kerning. The "units0" arguments is
	1/72000 of an inch multiplied by the current point size or 1/1000
	of an em (as in AFM kerning pair definitions). Same for char1/
	units1 etc.

.kernpair ff charf gg charg units			troff only
	adds a kerning pair to the kerning table for character "charf"
	from font "ff" and character "charg" from font "gg". The "units"
	argument is 1/72000 of an inch multiplied by the current point
	size or 1/1000 of an em (as in AFM kerning pair definitions). To
	add a kerning pair that includes the space character, use "\ ".

.lhang ff char0 units0 char1 units1 char2 units2 ...	troff only
	When the current font is "ff" and "char0" appears at the left margin
	of an output line in left-adjusted, both-adjusted, or nofill mode,
	the margin is relocated to the right by "units0", where units is
	1/72000 of an inch multiplied by the current point size or 1/1000
	of an em (as in AFM character width definitions). Same for
	char1/units1 etc.

.lc_ctype localename
	sets the LC_CTYPE locale setting to "localename". The default is
	the value of the LC_CTYPE environment variable. This request is
	useful to specify an input character set regardless of environment
	influences.

.mediasize executive|letter|legal|ledger|tabloid|aN|bN|cN|x y	troff only
	performs the same actions as the ".papersize" request and generates
	a device setup command in addition (the PostScript Level 2 operator
	"setpagedevice" with dpost). The effect of this command can be the
	selection of a matching paper tray on a printer; on the other hand,
	the document may not print at all if no such tray is available. In
	general, it is recommended to use printer-specific options from a
	PPD file when the file is submitted to the print spooling system
	instead of this request. However, when generating PostScript as
	intermediate format with the intent of PDF creation, use of this
	request is recommended.

.open stream filename
	opens "filename" for writing while truncating existing contents
	and associates "stream" with it for latter use with ".write" etc.

.opena stream filename
	works like ".open" but appends to "filename" instead of truncating
	an existing file.

.papersize executive|letter|legal|ledger|tabloid|aN|bN|cN|x y	troff only
	sets the paper size to the given format, which may be either one
	of the predefined American or international formats (such as a4),
	or a user-defined format "x y". The page length is set from these
	parameters, the page offset and line length are adjusted as needed,
	and the post-processor is informed about the page metrics for its
	internal calculations. The last action is the real reason why this
	request exists; without it, PostScript printers may displace the
	pages of the document. The default are "letter" measurements. This
	request should be used early in a document; if it is given multiple
	times, the last one will setup the device. See also ".mediasize".

.ps x.y							troff only
	accepts any points size now with PostScript devices, including
	fractional sizes.

.psbb filename
	reads the "%%BoundingBox" DSC comment from the PostScript document
	"filename" and assigns the lower left x coordinate to the register
	"\n[llx]", the lower left y coordinate to "\n[lly]", the upper
	right x coordinate to "\n[urx]", and the upper right y coordinate
	to "\n[ury]". All values are in points. If an error occurs, the
	registers are set to zero.

.pso shell-command
	executes "shell-command" and reads its standard output as text
	input.

.recursionlimit n
	sets the maximum stack depth for recursive invocations of macros to
	n. If n is zero, the stack depth is unlimited. The default limit is
	512.

.return
	immediately returns from the current macro to the level above.

.rhang ff char0 units0 char1 units1 char2 units2 ...	troff only
	When the current font is "ff" and "char0" appears at the right margin
	of an output line in right-adjusted or aligned mode, the margin is
	relocated to the right by "units0", where units is 1/72000 of an inch
	multiplied by the current point size or 1/1000 of an em (as in AFM
	character width definitions). Same for char1/units1 etc.

.shift [n]
	shifts the arguments to the current macro by "n", or 1 if "n"
	is missing.

.spreadlimit [n]
	sets or toggles a limit that causes a warning to be printed when
	it is exceeded by the adjustment that is computed for the current
	output line in ".ad b" mode. The limit is initially 3m, but the
	warning message is disabled. Calling this request without an
	argument toggles the warning message; calling it with an argument
	enables the warning and sets the limit to "n" (default scale m).

.ss n m							troff only
	with the second argument "m" determines whether additional white
	space is added between sentences. If m is zero, no additional
	white space is added. Otherwise, a space of size n is added as
	usual.

.tmc message
	is similar to ".tm" and writes "message" to standard error, but
	does not write a newline at the end.

.tr abcd...
	produces unspecified results if used with PostScript characters
	"\[name]", Unicode characters "\U'...'", or localized input. The
	".ftr" request should be used for such characters instead. With
	ASCII and traditional troff special characters, the ".tr" request
	continues to work as expected.

.track ff s1 n1 s2 n2					troff only
	specifies tracking of letter space for font ff. If the current font
	is ff and the point size is below or equal to s1, white space of
	width n1 is added to each character. If the point size is above or
	equal to s2, white space of width n2 is added. If the point size
	is between s1 and s2, the amount of white space added is computed
	as a value between n1 and n2 using the current point size s:
	(s * n2 - s * n1 + s2 * n1 - s1 * n2) / (s2 - s1). The default unit
	for all numeric arguments is "p". Negative numbers are accepted and
	cause a decrease of letter space. No adjustment is performed on the
	last character of an output line. Tracking also applies to characters
	from another font that have been selected by the fallback sequence.

.trimat left-offset top-offset width height
	sets the "TrimBox" page parameter for PDF generation and enables
	printing of visible cut marks and/or registration marks when used
	with "dpost -M cut:registration". The four arguments give the
	offset from the left and top margins of the document (as set by
	".mediasize"), and width and height of the box. The default units
	are points. The TrimBox specifies how the page is to be cut after
	it has been printed; it is sort of an electronic equivalent for
	cut marks (which should continue to be printed in addition). See
	also the ".cropat" and ".bleedat" requests.

.warn [+|-][bits|name] ...
	controls warning messages, which may be given either numerically
	as bits or symbolically as names. See below for defined bits and
	names. With a "+" sign, the respective bit or name is enabled in
	addition to the currently enabled categories; with a "-" sign,
	it is disabled. Omitting the sign sets the categories exactly to
	the given bit or name. If ".warn" is called without an argument,
	warnings are enabled. ".warn 0" disables all warnings.

.write stream message
	writes "message" to the file "stream", which must have been
	previously opened by ".open". Like ".tm", "message" is interpreted
	in copy mode.

.writec stream message
	is similar to ".write" and writes "message" to "stream", but does
	not write a newline at the end.

.xflag [0|1|2|3]
	controls the availability of newer features like the "-x" option
	as described above. Note that ".do xflag 0" is not reversible
	anymore since the ".do" and ".xflag" requests are only available
	at xflag level one and above.


New and changed escape sequences
================================

\$(nn
\$[nnn]
	refer to arguments "nn" or "nnn" to a macro.

\$*
	prints all arguments to a macro, separated by spaces.

\$@
	prints all arguments to a macro, each one surrounded by double
	quotes, separated by spaces.

\&
	inhibits kerning if put between two characters, in addition to
	its previous functionality.

\*[name]
	refers to the string "name".

\:
	is similar to "\%", but only inserts an optional line break and
	does not cause a hyphen to be printed if the line is split.

\[name]							troff only
	selects the character "name" as defined in the AFM, OpenType, or
	TrueType file for the current font. The script "stuff/showfont.sh"
	can be used to display the characters in such fonts along with
	their names.

\E
	is similar to "\e", but is not interpreted in copy mode.

\f[name]						troff only
	selects font "name".

\n[name]
	refers to the number register "name".

\N'number'
	produces unspecified results if "number" is outside the ASCII and
	traditional troff special character names range because the order
	of characters outside this range may vary. The "\[name]" request
	should be used to refer to special characters in PostScript Type 1,
	OpenType, and TrueType fonts.

\s'size'
	sets the current point size and allows any numerical expression
	in "size". This is particularly useful for specifying large sizes
	with more than two numerals, or for fractional sizes.

\U'n'
	selects the character with Unicode position "U+n", where "n" is
	a hexadecimal number.

\~
	is similar to "\ ", but inserts space that stretches when the
	line is adjusted like a regular " ".


New number registers
====================

\n(.s
	prints a decimal fraction if the current point size is not an
	integer. Since standard number registers cannot hold decimal
	fractions, point sizes must be saved and restored as follows:
		.nr os \n(.sp
		    . . .
		.ps \n(osu

\n[hours]
	prints the hours portion of the current local time [0,23].

\n[minutes]
	prints the minutes portion of the current local time [0,59].

\n[seconds]
	prints the seconds portion of the current local time [0,60].

\n[.warn]
	prints the bits representing the currently activated warning
	categories.

\n[year]
	prints the current year (2005 etc.).


Warning bits and names
======================

These are all warning bits and names for the ".warn" request that are
currently defined:

0	none	No warnings at all.
1	char	Warn when unknown glyph names like \(xx and \[xx] are
		found.
2	number	Warn when illegal numeric expressions occur.
4	break	Warn when a line in ".ad b" mode cannot be adjusted.
16	el	Warn when a ".el" is found without a matching ".ie".
32	scale	Warn when an undefined scale indicator is used in a
		numeric expression.
256	di	Warn when a ".di" is executed but no diversion is
		currently active.
512	mac	Warn when an undefined request, macro or string is
		called.
1024	reg	Warn when an undefined number register is accessed. The
		number register will be set to zero immediately after
		the first access so this warning can be printed only
		once per register name.
16384	input	Warn when illegal byte sequences or characters that have
		no known PostScript equivalent are read.
32768	escape	Warn when an undefined escape sequence is used.
65536	space	Warn when an unknown long request name is used, but its
		first two characters form a known regular request. The
		regular request is then executed in xflag level 2, or
		ignored in xflag level 3.
131072	font	Warn when a font cannot be found. This warning is enabled
		by default.
	all	All warnings except "di", "mac", and "reg". This may be the
		best choice when using tbl, eqn, or existing macro packages.
	w	All warnings.


Changes to troff intermediate output
====================================

s-23 d.d
	is a crude way to tell the post-processor that "d.d" is a
	(possibly fractional) point size for the current font. This
	command is only used if the "-x0" option was not given, if
	the "anysize" keyword is contained in the DESC file for the
	device, and if either the ".fzoom" request has been used, or
	a direct size change has resulted in a font size that is not
	contained in the DESC "sizes" table.

x font n filename
	tells the post-processor that "filename" contains the metrics
	for the font on position "n". This is certainly the change to
	intermediate output with the most impact. First, it will trigger
	buffer overflows in many existing variants of post-processors.
	Second, the way how information about the font is exchanged in
	the following output is specific to the current version of the
	AFM/OpenType handling routines. For all characters that are
	neither ASCII nor troff special, troff produces "Nnnn" commands,
	where "nnn" is the position of the character in an encoding that
	has been produced at runtime while reading the metrics data. The
	post-processor thus has to know about the encoding, and this is
	only guaranteed if the AFM/OpenType routines are the same as for
	troff.
	  If this is a problem, use -Tpost and no AFM or OpenType files.
	Sorry, but direct handling of Type 1 fonts comes at a certain price.

x H -23 d.d
	tells the post-processor about the character height, with "d.d"
	as a fractional point unit. Only generated under comparable
	circumstances as described for fractional point sizes.

x X BleedAt left-offset top-offset width height
	results from the ".bleedat" request and passes the given values
	in device units.

x X CropAt left-offset top-offset width height
	results from the ".cropat" request and passes the given values
	in device units.

x X PaperSize x y setmedia
	results from the ".mediasize" or ".papersize" requests and gives
	the paper size as "x" and "y" in device units. If "setmedia" is
	non-zero, PostScript code for "setpagedevice" will also be
	emitted. This command is not generated otherwise.

x X PDFMark attribute value
	includes information that is used by the distiller utility when
	generating PDF documents. Recognized types of "attribute" are:

	Author		"value" is the author of the document.
	Bookmark	"value" consists of two space-separated parts:
			An integer between 0 and 20 specifies the level
			of the bookmark. Bookmarks of the same level
			become children of the previous bookmark of the
			next higher level. The second part of "value"
			gives the bookmark title.
	BookmarkClosed	same as "Bookmark", but the initial view in the
			tree structure is closed, i.e. no children are
			visible.
	Keywords	"value" is a comma-separated list of keywords
			for cross-document searches.
	Subject		"value" is the subject of the document.
	Title		"value" is the title of the document.

	This command is not directly generated by troff, but is usable
	as e.g. "\X'PDFMark: Keywords foo, bar, baz'" or
	"\X'PDFMark: Bookmark 2 Title of subsection'".

x X PSSetup commands
	acts similar to "x X PS", but causes the commands to be written
	to the global setup section of the PostScript output. The point
	at which this request occurs in input is mostly not relevant;
	all such requests are written to the setup section in original
	order.

x X SupplyFont fontname filename
	results from the fourth argument to the extended ".fp" request
	and instructs the post-processor to include "filename" as glyph
	data for font "fontname".

x X Sync
	instructs the post-processor to write position and font information
	to the generated output exactly at the place where this escape
	sequence occurs. This is sometimes useful to ensure that
	following "\X'PS: ...'" commands work as expected. Not directly
	generated by troff, but usable as "\X'Sync'".

x X Track a
	gives a hint to the post-processor that the following
	characters are tracked by amount "a" in units. This is used
	by dpost for the PostScript "ashow" operator in order to
	reduce the size of the output. Interpretation of this command
	is completely optional; it does not change the semantics of
	the following output. It is only generated with the ".track"
	request.

x X TrimAt left-offset top-offset width height
	results from the ".trimat" request and passes the given values
	in device units.


Gunnar Ritter                                                   12/19/05
